## DNS ###################################################################
filter {
  if [@metadata][stage] == "zeek_network" and [event][dataset] == "dns" {
    if [dns] {

      mutate {
        rename => {
          "[dns][answers]" => "[dns][answers][name]"
          "[dns][query]" => "[dns][question][name]"
          "[dns][TTLs]" => "[dns][answers][ttl]"
          "[dns][qclass_name]" => "[dns][question][class]"
          "[dns][qtype_name]" => "[dns][question][type]"
          "[dns][rcode_name]" => "[dns][response_code]"
          "[dns][trans_id]" => "[dns][id]"
          "[dns][rtt]" => "[event][duration]"
        }
        copy => { "[dns][question][name]" => "[@metadata][destination_domain]" }
        merge => { "[related][domain]" => "[dns][question][name]" }
      }

      # Event outcome
      if [dns][rejected] {
        translate {
          field => "[dns][rejected]"
          exact => true
          dictionary => [
            "false", "success",
            "true", "failure"
          ]
          destination => "[event][outcome]"
          remove_field => "[dns][rejected]"
        }
      }

      if [dns][question][name] {
        # if [dns][qtype] == 1 (A) or 28 (AAAA), split out answers to hostnames & ips
        ruby {
          path => "/etc/logstash/conf.d/ruby/logstash-ruby-filter-dns-related.rb"
          script_params => {
            "query_field" => "[dns][question][name]"
            "query_type_field" => "[dns][question][type]"
            "answers_field" => "[dns][answers][name]"
          }
          tag_on_exception =>  "_rubyexception-zeek-dns_related_enrichment"
        }
      }

    }
  }
}