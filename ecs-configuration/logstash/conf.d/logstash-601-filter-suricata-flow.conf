filter {
  if [@metadata][stage] == 'suricata_json' {
    if [flow] {
      mutate {
        rename => {
          "[flow][age]" => "[event][duration]"
          "[flow][bytes_toclient]" => "[destination][bytes]"
          "[flow][bytes_toserver]" => "[source][bytes]"
          "[flow][pkts_toclient]" => "[destination][packets]"
          "[flow][pkts_toserver]" => "[source][packets]"
        }
      }
      ruby {
        code => "
          event_duration = event.get('[event][duration]')
          event.set('[event][duration]', event_duration * 1000000)
        "
        tag_on_exception => "_rubyexception-suricata-flow-duration_to_nanoseconds"
      }
    }
  }
}
